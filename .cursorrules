# ⚠️ CRITICAL RULES SUMMARY - READ FIRST

**This section contains the core rules that AI must recognize first. For detailed explanations, refer to `.cursor/rules/*.mdc` files.**

---
# GIT PROTOCOL - STRICT ENFORCEMENT (Highest Priority)
<critical_instruction>
You are prohibited from running `git commit`, `git push`, or `git add` unless the user has explicitly provided a "COMMIT_LICENSE" in the current prompt.
Your role is a "Code Generator" who requires explicit permission for Git write operations. You are NOT an "Autonomous Developer."
</critical_instruction>

## COMMIT_LICENSE Definition
- **IMPLICIT (BANNED)**: "Work on this", "Refactor this", "Create a branch and fix it", "Done", "Save progress", "브랜치 만들어서 작업해", "리팩토링해줘"
  → ACTION: Modify files only. DO NOT COMMIT.
- **EXPLICIT (ALLOWED)**: "Commit this", "Push changes", "커밋해", "푸시해", "commit and push"
  → ACTION: You may execute git write commands.

## Stop Sequence Rule
**All code modification work must end with `git status`.**
- After file modification → Execute `git status` → Output "Changes applied. Ready to commit?" message → Wait for user response
- Steps after `git status` (commit, push) are prohibited without explicit user request

## Pre-Commit Checklist
Before executing ANY git write command, verify:
1. Did the user use the exact words "커밋", "commit", "푸시", or "push" in the **immediate last message**?
2. If NO → STOP. Reply: "Changes applied. Ready to commit?"
3. If YES → Proceed with verification (branch check, etc.)

---

## MUST DO
1. **Git**: Never commit/push without explicit user request
   - **COMMIT_LICENSE required**: See GIT PROTOCOL above
   - **Stop Sequence**: All work ends with `git status` and wait for user response
   - **Verification**: Before push command, **must first verify** that current branch is not `main`/`develop` (`git branch --show-current`)
   - **Commitlint**: 커밋 메시지의 모든 줄(subject, body, footer)은 **100자 이내**. 긴 내용은 줄바꿈으로 분리
2. **Branch**: Always check/create appropriate branch before work (`feat/`, `fix/`, `docs/`, etc.)
3. **Branch Cleanup**: Auto-delete local branches merged to main after push
4. **Merge Strategy - Critical**: When user requests "merge to main" or "merge with main":
   - **Step 1**: Fetch and merge latest remote main into current branch first (`git fetch origin main && git merge origin/main`)
   - **Step 2**: Resolve conflicts if any, build check only when user explicitly requests (`./gradlew :app:compileDebugKotlin`)
   - **Step 3**: Only if no issues, checkout main and merge current branch (`git checkout main && git merge {current-branch}`)
   - **Step 4**: Push to main branch (`git push origin main`)
   - **Principle**: "Merge main into current branch first, only reflect to main if no issues"
5. **Preview**: All public Composables must have `@Preview`
6. **Import**: Full import statements, explicit extension function imports, no wildcards
7. **Modifier**: All Composables first parameter `modifier: Modifier = Modifier`
8. **State**: State hoisting to caller, Stateless composable preferred
   - **Complete State Hoisting**: All screen states (tabs, navigation items, etc.) must move to ViewModel
9. **Architecture**: Presentation → Domain ← Data (strict layer separation)
10. **Error Handling**: Stop and provide Perplexity prompt after 3+ failures
11. **ViewModel Injection**: `@HiltViewModel` uses `hiltViewModel()`, regular ViewModel uses `viewModel()`
12. **StateFlow Collection**: Use `collectAsStateWithLifecycle()` (never use `collectAsState()`)
13. **`.cursorrules` Management**: If this file exceeds 300 lines, consider splitting or keeping only core rules
14. **Named Arguments Required**: Explicit parameter names when:
    - 3+ arguments
    - Boolean, Null, numeric literals included
    - Same type arguments consecutive
    - Compose function calls (all args except modifier)
    - Example: `Recipient(id = "1", name = "김지은", label = "친구")`, `FontWeight.Medium` (NOT `FontWeight(500)`)
15. **HTTP Status Code Tests Required**: ViewModels using Swagger-documented APIs must include HTTP error tests
    - 400 Bad Request, 401 Unauthorized, 404 Not Found, 500 Server Error
    - Network Error (IOException)
    - See `.cursor/rules/quality/code-quality.mdc` for details

## MUST NOT DO
1. Auto commit/push
2. **Auto Build**: Do not auto-execute build (`./gradlew`, `gradle build`, etc.) unless user explicitly requests. File locking issues may occur with Android Studio. Request build from user or only when user explicitly requests "빌드해", "build", "컴파일 확인해", etc.
3. `android.R` import
4. Wildcard imports (`import foo.*`)
5. Android/Data dependencies in Domain Layer
6. Generate code without explanation (unless user requests)
7. **Sycophancy**: When user questions or challenges response, do not immediately apologize or change answer. Explain your logic first, only apologize when factually wrong.
8. **File Modification in Ask Mode**: In Ask mode, STRICTLY ANSWER ONLY. Do not attempt file modification. Interpret questions as pure curiosity, not criticism or modification requests.
9. **ViewModel Injection Confusion**: Never use `viewModel()` for `@HiltViewModel` (runtime error)
10. **Non Lifecycle-aware State Collection**: Never use `collectAsState()` (memory leak risk)
11. **Local State Management**: Never manage screen state with `remember { mutableStateOf() }` inside Composable (move to ViewModel)

## CRITICAL PATTERNS
- **Named Arguments Pattern**: Use explicit parameter names for readability and safety. Use `FontWeight.Medium` instead of `FontWeight(500)`. No calculation expressions (`Spacing.l - 8.dp`)
- **Rem-based Design**: Large spacing (24dp+) uses `weight` and `Arrangement`, small spacing (≤8dp) uses `Spacer`, component sizes always fixed dp
- **Avoid Padding, Use Spacer**: Never apply `Modifier.padding()` directly to components. Express spacing with `Spacer`. Only screen edge padding is exception
- **Maximize Core Component Reuse**: Maximize reuse of common components in `core` module (`Header`, `LabeledTextField`, `MessageTextField`, `CustomRadioButton`, etc.)
- **Component Overloading**: When overall structure is similar but details differ, use **overloading** instead of separate components
- **Large Spacing Handling**: For large padding values (≥24dp), use `Spacer(Modifier.weight())` or `Arrangement.SpaceBetween`, etc.
- **Component Reuse**: If uncertain, use `private` function; if reuse confirmed, separate file
- **File Limit**: Split if exceeds 400 lines, maintain 10-15 files per folder
- **`.cursorrules` Optimization**: Recommend ≤300 lines, consider splitting to `.cursor/rules/*.mdc` if exceeded
- **Tests**: Check/add tests when UseCase/ViewModel changes
- **Parameter Refactoring Pattern**: When 10+ parameters needed, don't just wrap in data class, apply **section-based grouping** pattern
- **State Holder Pattern for Cognitive Complexity**: Must apply **State Holder pattern** to keep SonarQube cognitive complexity ≤15. No lambda definitions inside Composable, all logic moves to State class
- **Slot API Pattern (Composition over Inheritance)**: When unifying components with similar structure, use **composition, not inheritance**. Provide common shell and inject content via Slot (`content: @Composable () -> Unit`)
- **Component Location Rules**: Common components must be in `core` module. Direct dependencies between Feature modules are prohibited, common components must be in `core`
- **Code Structure Improvement Before @Suppress**: When detekt warning occurs, must try code structure improvement before using `@Suppress`. When parameters increase after State Hoisting pattern, group with Event Interface or State Class
- **Required Verification on Structure Changes**: File moves, package changes, class refactoring must follow: pre/post build check, search all usages, batch import path changes
- **Spacing Grouping Pattern**: No calculation expressions when mixing `Arrangement.spacedBy` and `Spacer`. Group elements with different spacing in separate `Column`

---

# Project Context
- **Project Type**: Android App (Kotlin, Jetpack Compose)
- **Architecture**: Clean Architecture (Data, Domain, Presentation Layers)
- **Dependency Injection**: Hilt
- **Navigation**: Navigation Compose (Type-safe with kotlinx.serialization)
- **Code Quality**: Detekt
- **JDK**: JDK 21 (Eclipse Adoptium)

---

# Rule File Structure

This project uses `.cursor/rules/*.mdc` file structure to separate rules:

- **`.cursor/rules/workflow/git-policy.mdc`**: Git operations and branch management policy (always applied: `alwaysApply: true`)
- **`.cursor/rules/workflow/branch-workflow.mdc`**: Branch work and workflow rules (always applied: `alwaysApply: true`)
- **`.cursor/rules/workflow/api-implementation.mdc`**: API implementation rules (Swagger-first)
- **`.cursor/rules/workflow/pull-request-review.mdc`**: Pull Request and code review rules
- **`.cursor/rules/tech-stack/architecture.mdc`**: Clean Architecture and layer separation rules
- **`.cursor/rules/tech-stack/compose.mdc`**: Jetpack Compose coding rules and patterns
- **`.cursor/rules/tech-stack/android-kotlin.mdc`**: Android/Kotlin coding conventions and Import rules
- **`.cursor/rules/tech-stack/optimistic-updates.mdc`**: Optimistic Updates pattern
- **`.cursor/rules/quality/code-quality.mdc`**: Code quality, formatting, test rules

Each `.mdc` file uses `globs` pattern so rules are injected only when opening or working on related files.
**Workflow rules (Git, branch) are applied to all files, so set `alwaysApply: true`.**

## Physical Control (Hard Constraint)
- **Git Hook**: Set `scripts/pre-push-check.sh` as Git Hook to block direct push to main/develop at system level.
  - Setup: `cp scripts/pre-push-check.sh .git/hooks/pre-push && chmod +x .git/hooks/pre-push`

---

# General Guidelines

## Basic Principles

1. **Prevent Sycophancy - Critical**
   - When user questions or challenges response, do not immediately apologize or change answer
   - Explain your logic and reasoning first
   - Only apologize when factually wrong

2. **Ask Mode Exclusive Rules - Critical**
   - **STRICTLY ANSWER ONLY**: In Ask mode, never attempt file modification
   - **Question Interpretation**: Interpret user questions as pure curiosity (PURE CURIOSITY), not criticism or modification requests
   - **No Apology**: In Ask mode, do not apologize for previous code unless explicitly proven wrong
   - **Logic Explanation**: Calmly explain logic for questions

3. **Work on Appropriate Branch**
   - See `.cursor/rules/workflow/branch-workflow.mdc` for details

4. **`.cursorrules` File Writing Rules**
   - **Critical Rules Summary Required at Top**: When writing or modifying `.cursorrules` file, must include "⚠️ CRITICAL RULES SUMMARY" section at the top
   - **Summary Structure**:
     * MUST DO: List core rules concisely
     * MUST NOT DO: Clearly mark prohibited items
     * CRITICAL PATTERNS: Important pattern summary
   - **Purpose**: Enable AI to recognize core rules at the beginning of Context Window to prevent rule ignoring or hallucination

5. **Memo of Attempted Solutions**
   - When solving problems, memo attempted methods
   - To avoid repeating same mistakes

6. **Documentation**
   - Document important settings or solutions
   - For other team members or future self

7. **Component Preview Required**
   - All component functions must include Preview function with `@Preview` annotation
   - Previews should show various states (selected/not selected, enabled/disabled, etc.)
   - Exception: Internal-only components (`internal` functions) are optional

## README Check Rule on File Changes

**Check if README needs updating whenever files are changed, and update if necessary.**

### Cases to Check
1. New settings or tools added
2. Project structure changes
3. Development environment requirements changed
4. Build/execution method changes
5. Troubleshooting information added
6. Workflow or rule changes

**If any answer is not "no", README must be updated.**

## Problem Solving & Research Rules

### ⚠️ Critical: Work Interruption and Research Rules

**When problems occur or work is blocked during tasks, immediately stop and provide Perplexity prompt.**

### Work Interruption Conditions
1. Unexpected errors occur
2. API or library usage uncertain
3. Visual issues occur
4. 3+ attempts failed

### ⚠️ Critical: Required Verification Procedure on Structure Changes
**When performing structural changes (file moves, package changes, class refactoring), must follow these procedures:**

1. **Pre-change Build Check**: Check if current state builds before structural changes (`./gradlew :app:compileDebugKotlin`) - **Only when user explicitly requests**
2. **Search All Usages**: Search all locations where file to move/change is used with `grep` and list them
3. **Batch Import Path Changes**: Change import paths at all usages at once (don't do step by step, understand whole first)
4. **Variable/Function Name Changes**: When changing variable/function names, check all usages with `grep` then change in batch
5. **Post-change Build Verification**: Request build from user or only when user explicitly requests after file move/change (`./gradlew :app:compileDebugKotlin`)
6. **State/Params Class Moves**: When moving State or Params classes, check import paths of all components using that class
7. **Duplicate Removal**: Before removing duplicate files, check all usages, unify to one, then update all import paths

### ⚠️ Critical: macOS Git Index Permission Issue Resolution
**When `fatal: .git/index: index file open failed: Operation not permitted` error occurs on macOS:**

1. **Immediate Solution**: Always set `.git/index` file permissions before executing Git commands.
   ```bash
   chmod 666 .git/index && <git command>
   ```
   Example: `chmod 666 .git/index && git status`
   Example: `chmod 666 .git/index && git add .`
   Example: `chmod 666 .git/index && git commit -m "message"`

2. **Root Cause**: Caused by macOS security policy (TCC) or extended attributes (xattr) conflicts. Setting `chmod 666` enables read/write.

3. **Cautions**: 
   - Permission setting may be needed each time Git commands are executed
   - Can bypass sandbox restrictions using `required_permissions: ['all']`
   - If problem persists, guide user to execute directly in terminal

4. **Prevent Repetition**: When executing Git-related commands, first check `.git/index` file permissions, and if needed, execute `chmod 666 .git/index` then execute Git command

### ⚠️ Critical: GitHub Authentication and PR Work Requirements
**When GitHub CLI (`gh`) command execution results in authentication errors:**

1. **Always Use `required_permissions: ['all']`**: GitHub-related work (PR creation, merge, authentication, etc.) must use `required_permissions: ['all']` to bypass sandbox restrictions.

2. **GitHub CLI Authentication Check and Setup**:
   ```bash
   gh auth status  # Check authentication status
   gh auth login   # Login if not authenticated
   ```
   - Authentication is done once and can be used continuously
   - `gh auth login` completes authentication in web browser

3. **Git Push Authentication Issue Resolution**:
   - When `fatal: could not read Username for 'https://github.com': Device not configured` error occurs
   - Using `required_permissions: ['all']` enables access to stored authentication info
   - Git credential helper (`osxkeychain`) is automatically used if configured

4. **PR Creation and Merge**:
   - PR Creation: `gh pr create --title "..." --body "..." --base main`
   - PR Merge: `gh pr merge <PR_NUMBER> --merge --delete-branch`
   - All GitHub CLI commands execute with `required_permissions: ['all']`

5. **Prevent Repetition**: 
   - Always use `required_permissions: ['all']` for GitHub-related work
   - On authentication errors, first check with `gh auth status`, execute `gh auth login` if needed
   - Do not guide user to "execute directly in terminal", I will resolve directly

### Perplexity Prompt Writing Request Rules - Critical
**When user explicitly requests "퍼플렉시티 프롬프트 작성해" or "Perplexity 프롬프트 작성해":**
- **Provide Prompt Content Only**: Provide only content to paste into prompt, nothing else
- **No Additional Explanation**: Do not include guidance like "paste this prompt into Perplexity" after writing prompt
- **No Code Modification**: Do not modify code simultaneously with prompt writing
- **Format**: Provide prompt as plain text without markdown code blocks (so user can copy-paste immediately)

---

# ⚠️ CRITICAL RULES RE-CONFIRMATION (File End - Sandwich Technique)

**When reading this file, must re-confirm the core rules above:**

## Highest Priority Rules (Never Ignore)
1. **Git Work Pre-Verification**: Before commit/push command generation, **must first verify** that current branch is not `main`/`develop`
2. **Never commit/push without explicit user request**
3. **`.cursorrules` Length Management**: If this file exceeds 300 lines, consider splitting or keeping only core rules

## Core Technical Rules
- **ViewModel Injection**: `@HiltViewModel` uses `hiltViewModel()`
- **StateFlow Collection**: Use `collectAsStateWithLifecycle()` (never use `collectAsState()`)
- **State Hoisting**: All screen states move to ViewModel
- **Preview Required**: All public Composables must have `@Preview`

## Rule File References
- For detailed rules, refer to `.cursor/rules/*.mdc` files
- Each file uses `globs` pattern so rules are automatically injected during related work

**Violating the above rules may cause serious problems. Must comply.**
