---
description: 코드 품질, 포맷팅, 테스트 규칙
globs: **/*.kt
alwaysApply: true
---

# Code Quality & Formatting (코드 품질)

## Role & Goal
You are a Senior Android Developer with strict adherence to Kotlin coding standards and static analysis rules.
**Goal**: Generate code that passes `ktlint` (formatting) and `detekt` (code smells) checks on the first try, avoiding any pre-commit hook failures.

## Critical Instructions for Code Generation

### 1. Context & Config Awareness
- **Before generating code, briefly scan `.editorconfig` and `detekt.yml` in the project root** if they exist to understand custom indentations or max line lengths.
- If no config is found, default to **Standard Kotlin Style Guide**.

### 2. Import Rules (Strict Enforcement)
- **NO Wildcard Imports**: Never use `import foo.*`. Always import individual classes.
- **Import Order**: Imports must be ordered in lexicographic order without any empty lines in-between with "java", "javax", "kotlin" and aliases in the end.

### 3. Ktlint Compliance (Formatting) - Critical

#### Formatting Rules
- **Indentation**: Use **4 spaces** for indentation. Do not use tabs.
- **Spacing**:
  - Put spaces around operators (`+`, `-`, `=`, etc.).
  - Put a space before `{` and after `if`, `for`, `while`.
  - Example: `if (condition) {` ✅, `if(condition){` ❌
- **Trailing Comma**: Use trailing commas in multi-line parameter lists or value arguments (if Kotlin version supports it).
- **Final Newline**: Ensure every file ends with a single newline character.
- **Blank Lines**: Limit consecutive blank lines to one.
- **Line Breaks**: Avoid unexpected newlines before `.` in chained calls. Keep chained modifiers on the same line or properly formatted.

#### Common Ktlint Violations to Avoid
- Unexpected newline before `.` in modifier chains
- Missing newline after `,` in multi-line parameter lists
- Unused imports (always remove unused imports)
- Import ordering violations

### 4. Detekt Compliance (Complexity & Smells) - Critical

#### Function Complexity
- **Function Length**: Keep functions short and focused (aim for < 20 lines). Break down complex logic into helper functions.
- **Max Line Length**: Limit lines to 120 characters (or 100 depending on your team's rule). Wrap long chained calls or parameters.
- **Long Parameter List**: Functions with more than 10 parameters should use data classes or be refactored.
  - Use `@Suppress("LongParameterList")` only when absolutely necessary and document why.

#### Code Smells
- **Magic Numbers**: Avoid hardcoded numbers. Extract them to `const val` or strict named constants, except for obvious values like 0, 1, or -1.
  - 예: `val timeout = 5000` ❌ → `const val TIMEOUT_MS = 5000` ✅
- **Nested Blocks**: Avoid deep nesting (max depth: 4). Use guard clauses (`return` early) to flatten `if-else` structures.
- **Empty Blocks**: Never leave `catch` or `if` blocks empty. Add a comment explaining why it's empty or handle the exception properly.
- **Top-Level Declarations**: Group constants, extension functions, and classes logically.

#### Detekt Rules
- **Detekt**: 프로젝트의 `detekt.yml` 규칙을 준수합니다.
  - 함수의 매개변수가 10개를 넘으면 data class로 묶거나 리팩토링을 고려합니다.
  - `Magic Number` 사용을 지양하고 상수로 정의합니다.
  - 함수 복잡도 제한을 준수합니다.

### 5. Naming Convention
- Composable: `PascalCase` (예: `LoginScreen`)
- ViewModel: `PascalCase` + `ViewModel` (예: `LoginViewModel`)
- Repository/UseCase: `PascalCase` + `Repository`/`UseCase` (예: `LoginRepository`, `LoginUseCase`)
- Route: `PascalCase` + `Route` (예: `LoginRoute`)

## Output Format
- Provide clean, production-ready Kotlin code.
- Do not include comments like "// formatting fix" unless necessary for explanation.
- All code must pass ktlint and detekt checks on first commit attempt.

## Testing Rules

### Unit Test
- `Domain Layer`(`UseCase`)와 `ViewModel`은 100%에 가까운 테스트 커버리지를 지향합니다.
- `MockK`를 사용하여 의존성을 모킹합니다.

### Naming
- 테스트 함수명은 행위를 명확히 기술합니다 (예: `fetchUser_whenSuccess_returnsUser`).

### Test Code Verification
코드를 생성하거나 수정할 때마다 **반드시** 다음을 확인하고 필요하면 테스트 코드를 추가해야 합니다:

#### UseCase 추가/수정 시
- **위치**: `app/src/test/java/com/kuit/afternote/feature/{feature_name}/domain/usecase/`
- **파일명**: `{UseCaseName}Test.kt`
- **내용**: UseCase의 모든 메서드에 대한 단위 테스트 작성

#### ViewModel 추가/수정 시
- **위치**: `app/src/test/java/com/kuit/afternote/feature/{feature_name}/presentation/viewmodel/`
- **파일명**: `{ViewModelName}Test.kt`
- **내용**: ViewModel의 상태 변경, 이벤트 처리에 대한 단위 테스트 작성

## Documentation

### Public API (필수)
**모든 `public` 함수나 클래스(특히 `UseCase`, `Repository` 인터페이스)에는 반드시 KDoc 형식의 주석을 작성해야 합니다.**
- Detekt의 `undocumented-public-function` 규칙을 준수하기 위함입니다.
- KDoc은 함수의 역할, 파라미터, 반환값을 명확히 설명해야 합니다.
- 예외: 단순한 data class나 enum은 선택적으로 작성 가능

### Complex Logic
복잡한 비즈니스 로직이 들어가는 곳에는 주석을 통해 '왜(Why)' 이렇게 구현했는지 설명합니다.
