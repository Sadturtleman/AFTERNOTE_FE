---
description: Git 작업 및 브랜치 관리 정책
globs: "**/*"
alwaysApply: true
---

# Git & Commit Rules (커밋 규칙)

## ⚠️ GIT PROTOCOL - STRICT ENFORCEMENT

<critical_instruction>
You are prohibited from running `git commit`, `git push`, or `git add` unless the user has explicitly provided a "COMMIT_LICENSE" in the current prompt.
Your role is a "Code Generator" with READ-ONLY git access. You can write code but cannot sign off (commit) on it without explicit permission.
</critical_instruction>

### COMMIT_LICENSE 정의

| 요청 유형 | 예시 | 허용 액션 |
|----------|------|----------|
| **IMPLICIT (금지)** | "브랜치 만들어서 작업해", "리팩토링해줘", "새 기능 구현해", "Work on this", "Fix it" | 파일 수정만. 커밋 금지. |
| **EXPLICIT (허용)** | "커밋해", "commit", "푸시해", "push", "커밋하고 푸시해" | Git write 명령 실행 가능 |

### Stop Sequence Rule (필수)
**모든 코드 변경 작업은 `git status`에서 종료해야 합니다.**

```
[작업 완료] → git status 실행 → "Changes applied. Ready to commit?" 출력 → 사용자 응답 대기
```

- `git status` 이후 단계(add, commit, push)는 사용자의 명시적 COMMIT_LICENSE 없이 진행 금지
- 사용자가 "Yes", "OK" 등으로 응답해도, "커밋" 또는 "commit" 키워드가 없으면 커밋하지 않음

### Pre-Commit Checklist (커밋 전 필수 확인)
Before executing ANY git write command (`git add`, `git commit`, `git push`):
1. **키워드 확인**: 사용자의 **직전 메시지**에 "커밋", "commit", "푸시", "push" 키워드가 있는가?
2. **NO** → STOP. Reply: "Changes applied. Ready to commit?"
3. **YES** → 브랜치 검증 후 진행

### Allowed Commands (허용된 명령어 - 권한 불필요)
- `git status`, `git diff`, `git log`, `git branch` (READ-ONLY)
- `git checkout`, `git checkout -b` (브랜치 전환/생성)
- `ls`, `cat`, `grep`, `find` (파일 탐색)

### Prohibited Commands (금지된 명령어 - COMMIT_LICENSE 필수)
- `git add` (커밋 직전에만 허용)
- `git commit`
- `git push`
- `git merge` (병합 요청 시에만)

---

### 1. 커밋 금지 원칙
- 사용자가 "커밋해", "commit", "git commit" 등 명시적으로 커밋을 요청하지 않으면 커밋하지 않습니다
- 코드 변경만 하고 커밋은 하지 않습니다
- 사용자가 커밋을 요청하지 않았는데 커밋한 경우, 즉시 취소해야 합니다

### 2. 커밋 허용 조건
- 사용자가 명시적으로 "커밋해", "commit", "git commit" 등을 요청한 경우에만 커밋합니다
- 사용자가 "커밋하고 푸시해"라고 요청한 경우에만 커밋합니다
- **COMMIT_LICENSE 키워드 필수**: 사용자 메시지에 "커밋", "commit", "푸시", "push" 키워드가 직접 포함되어야 함

### 3. 푸시 금지 원칙
- 사용자가 "푸시해", "push", "push origin", "git push" 등 명시적으로 푸시를 요청하지 않으면 푸시하지 않습니다
- 커밋만 하고 푸시는 하지 않습니다
- 사용자가 푸시를 요청하지 않았는데 푸시한 경우, 즉시 취소해야 합니다

### 4. 푸시 허용 조건
- 사용자가 명시적으로 "푸시해", "push", "git push" 등을 요청한 경우에만 푸시합니다
- 사용자가 "커밋하고 푸시해"라고 요청한 경우에만 푸시합니다

### 5. 검증 절차 (Critical)
**푸시 명령 생성 전, 현재 브랜치가 `main`/`develop`이 아닌지 반드시 먼저 검증하시오.**
- `git branch --show-current`로 현재 브랜치 확인
- 만약 `main`이나 `develop`이라면 작업을 중단하고 경고 메시지를 출력하시오
- **물리적 제어**: 프로젝트 루트의 `scripts/pre-push-check.sh` 스크립트를 Git Hook으로 설정하여 시스템 레벨에서 차단하세요.
  - 설정 방법: `cp scripts/pre-push-check.sh .git/hooks/pre-push && chmod +x .git/hooks/pre-push`

### 6. 취소 방법
- 실수로 커밋한 경우: `git reset --soft HEAD~1` (변경사항은 유지) 또는 `git reset --hard HEAD~1` (변경사항도 제거)
- 실수로 푸시한 경우: `git reset --hard HEAD~1` 후 `git push origin {branch-name} --force-with-lease`로 원격에서도 제거

### 7. 병합 전략 (Merge Strategy) - Critical
**사용자가 "메인에 병합해" 또는 "메인과 병합해"라고 요청한 경우, 다음 절차를 반드시 따라야 합니다:**

#### 병합 절차 (4단계)
1. **1단계: 현재 브랜치에 원격 main 병합**
   - 현재 브랜치 확인: `git branch --show-current`
   - 원격 main 최신화: `git fetch origin main`
   - 현재 브랜치에 main 병합: `git merge origin/main`
   - 목적: 충돌을 현재 브랜치에서 먼저 해결

2. **2단계: 충돌 해결 및 빌드 확인**
   - 충돌이 있으면 해결
   - 빌드 확인: `./gradlew :app:compileDebugKotlin`
   - 문제가 있으면 사용자에게 알리고 중단

3. **3단계: main 브랜치로 체크아웃 및 병합**
   - 문제가 없을 때만 진행: `git checkout main`
   - main 브랜치 최신화: `git pull origin main` (필요시)
   - 현재 브랜치를 main에 병합: `git merge {현재브랜치}`

4. **4단계: main 브랜치 푸시**
   - 검증: 현재 브랜치가 `main`인지 확인 (`git branch --show-current`)
   - 푸시: `git push origin main`

#### 원칙
- **"먼저 현재 브랜치에 main을 병합하고, 문제 없을 때만 main에 반영"**
- 충돌이나 빌드 오류가 있으면 main에 병합하지 않음
- 모든 단계에서 문제가 발생하면 사용자에게 알리고 중단

### 8. 브랜치 정리 규칙 (Branch Cleanup Rule) - Critical
**커밋/푸시 완료 후 자동으로 병합된 브랜치를 정리합니다.**

#### 자동 정리 조건
- **푸시 완료 후 자동 실행**: 작업 브랜치를 푸시한 후, `main` 브랜치에 병합된 로컬 브랜치를 자동으로 삭제합니다.
- **삭제 대상**:
  * `main` 브랜치에 병합된 로컬 브랜치 (`git branch --merged main`)
  * 현재 브랜치가 아닌 브랜치
  * `main`, `master`, `develop` 브랜치가 아닌 브랜치
- **삭제하지 않는 브랜치**:
  * 현재 작업 중인 브랜치 (체크아웃된 브랜치)
  * `main`, `master`, `develop` 브랜치
  * `main`에 병합되지 않은 브랜치 (`git branch --no-merged main`)
  * Worktree에서 사용 중인 브랜치

#### 실행 방법
- **자동 실행**: 푸시 완료 후 자동으로 실행
- **수동 실행**: 사용자가 "브랜치 정리" 또는 "불필요한 브랜치 삭제"를 요청한 경우 실행
- **명령어**: `git branch -d $(git branch --merged main | grep -v "main\|master\|develop\|^\*" | xargs)`

#### 브랜치 추적 설정 (Branch Tracking)
- **푸시 시 자동 추적 설정**: 새로운 브랜치를 푸시할 때는 반드시 `-u` 옵션을 사용하여 원격 브랜치 추적을 자동으로 설정합니다.
  - 명령어: `git push -u origin <branch-name>`
  - 목적: IDE에서 브랜치 상태를 올바르게 표시하고, "퍼블리시" 메시지를 방지합니다.
- **기존 브랜치 추적 확인**: 푸시 전에 `git branch -vv`로 브랜치 추적 상태를 확인하고, 추적이 설정되지 않은 경우 `git branch --set-upstream-to=origin/<branch-name> <branch-name>`으로 설정합니다.

#### 원격 브랜치 정리
- **자동 삭제**: 푸시 완료 후 `origin/main`에 병합된 원격 브랜치를 자동으로 삭제합니다.
- **삭제 대상**:
  * `origin/main`에 병합된 원격 브랜치 (`git branch -r --merged origin/main`)
  * `main`, `master`, `develop` 브랜치가 아닌 브랜치
- **삭제하지 않는 브랜치**:
  * `main`, `master`, `develop` 브랜치
  * `origin/main`에 병합되지 않은 브랜치 (`git branch -r --no-merged origin/main`)
  * 현재 작업 중인 브랜치 (체크아웃된 브랜치)
- **명령어**: `git push origin --delete <branch-name>` (병합된 브랜치들)
- **추적 제거**: `git remote prune origin` (원격에서 이미 삭제된 브랜치 추적 제거)

## Conventional Commits
커밋 메시지는 아래 형식을 따릅니다:
`type(scope): subject`

- **PR 제목**: Pull Request 생성 시에도 동일한 `type(scope): subject` 형식을 사용합니다. (`pull-request-review.mdc` 참고)
- **Types**:
  - `feat`: 새로운 기능 추가
  - `fix`: 버그 수정
  - `refactor`: 코드 리팩토링 (기능 변경 없음)
  - `style`: 포맷팅, 세미콜론 누락 등 (코드 변경 없음)
  - `docs`: 문서 수정
  - `test`: 테스트 추가/수정
  - `chore`: 빌드 태스크, 패키지 매니저 설정 등
  - `build`: 빌드 시스템 또는 외부 종속성 변경
  - `ci`: CI 설정 파일 및 스크립트 변경
  - `perf`: 성능 개선

## Example
- `feat(auth): add login usecase`
- `fix(ui): correct padding in home screen`
- `refactor(navigation): apply navigator pattern`
